{
  nixConfig = {
    extra-substituters = [
      "https://nix-cache.fossi-foundation.org"
    ];
    extra-trusted-public-keys = [
      "nix-cache.fossi-foundation.org:3+K59iFwXqKsL7BNu6Guy0v+uTlwsxYQxjspXzqLYQs="
    ];
  };

  inputs = {
    #nix-eda.url = "github:fossi-foundation/nix-eda/5.13.0";
    librelane = {
      url = "github:librelane/librelane/leo/ihp-sg13g2";
      #inputs.nix-eda.follows = "nix-eda";
    };
  };

  outputs =
    {
      self,
      librelane,
      ...
    }:
    let
      nix-eda = librelane.inputs.nix-eda;
      devshell = librelane.inputs.devshell;
      nixpkgs = nix-eda.inputs.nixpkgs;
      lib = nixpkgs.lib;
    in
    {
      # Outputs
      legacyPackages = nix-eda.forAllSystems (
        system:
	import nixpkgs {
	  inherit system;
	  overlays = [
	    nix-eda.overlays.default
	    devshell.overlays.default
	    librelane.overlays.default
	    (import ./nix/overlay-eqy.nix)
	  ];
	}
      );

      packages = nix-eda.forAllSystems (system: {
        inherit (self.legacyPackages.${system}.python3.pkgs) ;
      });

      devShells = nix-eda.forAllSystems (
        system:
        let
          pkgs = (self.legacyPackages.${system});
          callPackage = lib.callPackageWith pkgs;
        in
        {
          default = callPackage (pkgs.createLibreLaneShell {
            extra-packages = with pkgs; [
              # Utilities
              gnumake
              gnugrep
              gawk

              # Simulation
              iverilog
              verilator

              # Waveform viewing
              gtkwave
              surfer
            ];

            extra-python-packages = with pkgs.python3.pkgs; [
              # Verification
              cocotb

              # For KLayout Python DRC runner
              docopt

              # For logo generation
              pillow
            ];
          }) { };
        }
      );
    };
}
